## NAT(Network Address Translation)

### 一、 基本概念
- **定義**：網路位址轉換。將「私有 IP」與「公用 IP」進行互換的技術。
- **核心目的**：
    1. **解決 IPv4 枯竭**：讓多個裝置共用一個公網 IP（最主要功勞）。
    2. **安全性**：隱藏內部網路結構，外部裝置無法直接主動連線內部設備。
- **關鍵角色**：**路由器 (Gateway)**。它是內外網的翻譯官。

### 二、 NAT 的四種類型（保全嚴格度）

1. **全錐型 (Full Cone)**：最寬鬆。只要內部發過一次包，任何人都能從外部連入該埠號。
2. **受限錐型 (Address Restricted)**：只檢查 IP。只有你主動連過的「人」可以回信。
3. **埠受限錐型 (Port Restricted)**：檢查 IP + Port。家用路由器最常見。
4. **對稱型 (Symmetric)**：最嚴格。連向不同目標會換不同門牌（Port），無法預測，企業防火牆常用。

---
# >以下是應對NAT的對外溝通方式

## 端口轉發 (Port Forwarding) >用於網路有控制權(能進路由器)

### 一、 基本概念

- **定義**：在路由器（NAT 設備）上手動設定一條規則，告訴路由器：「只要看到從外部傳來、目標是 **特定端口（Port）** 的封包，就通通轉交給內部特定的 **某台電腦**」。
- **目的**：徹底解決 NAT 導致「外部無法主動發起連線」的問題。
- **別名**：在許多家用路由器後台，這項功能也被稱為 **「虛擬伺服器」(Virtual Server)**。

### 二、 運作原理（就像收發室轉接）

想像你的路由器是公司的總機，內部電腦是分機：
1. **外部請求**：一個外網玩家連向你的公網 IP，且指名要找 `25565` 端口（例如 Minecraft 伺服器）。
2. **查詢規則**：路由器收到後，不會直接丟棄，而是翻開「轉發清單」。
3. **精準傳送**：清單寫著：`25565 轉發到 192.168.1.100`。
4. **成功連線**：路由器把封包送往 `192.168.1.100`，內外連線建立。

## P.S. UPnP (Universal Plug and Play)
### 一、 基本概念

- **定義**：一種網路協定，允許電腦、遊戲機或其他網路設備，自動在路由器上發現並開啟所需的通訊埠（Port）。(懶人行端口轉發)
- **核心功能**：**自動化的端口轉發**。
- **本質**：它解決了「一般使用者不會進路由器後台設定」的問題。

### 二、 運作原理：對話式開門

想像一個軟體（例如 BitTorrent 或 Skype）啟動時的過程：
1. **設備詢問**：軟體發現自己在 NAT 後面，於是對區網發出廣播：「誰是支援 UPnP 的路由器？」
2. **路由器回應**：路由器說：「我是，你有什麼需要？」
3. **請求開門**：軟體說：「請幫我把外部的 `12345` 埠對應到我的內部 IP `192.168.1.10`。」
4. **自動生效**：路由器點頭並自動新增一條暫時的端口轉發規則，無需人工干預。

### 三、 UPnP 的優缺點對比

| **特性**  | **優點**                    | **缺點 (安全隱患)**                                |
| ------- | ------------------------- | -------------------------------------------- |
| **便利性** | 玩遊戲、下載檔案、視訊通話時，完全不需要手動設定。 | **缺乏權限驗證**：任何軟體只要能連上區網，都能要求路由器開門。            |
| **效率**  | 軟體關閉後，理論上該埠號會自動關閉，不佔空間。   | **惡意軟體利用**：木馬程式可以偷偷透過 UPnP 開門，建立外部連線，讓你毫不知情。 |
| **相容性** | 絕大多數家用路由器都預設支援此功能。        | **隱私問題**：外部攻擊者可能透過掃描開放的埠號找到內部設備。             |
## 四、 實務建議：開還是關？

- **一般家庭用戶**：建議**開啟**。否則你的遊戲主機（Switch/PS5）可能會經常出現 NAT Type C，或是遠端監控、視訊軟體連線不穩定。
- **企業或高度安全環境**：絕對**關閉**。網管人員會嚴格控制每一個對外開放的埠號，不允許軟體隨意「鑽洞」。

### P.S. mc server
對於長時間開啟的伺服器 建議還是使用端口轉發+靜態租約 因為路由由重啟或租約到期都有可能讓UPnp設定失效 且對於網路安全性隱患不小

---
## UDP 打洞 (Hole Punching) >用於沒網路控制權
### 一、 核心定義

- **名詞解釋**：UDP 打洞是一種利用 UDP 協定的特性，讓兩個位於 **NAT 後方** 的設備在「不需要」手動設定路由器（Port Forwarding）的情況下，建立直接連線（P2P）的技術。
- 它利用了防火牆會「放行回信」的邏輯，人為製造出一個雙向通訊的假象。

### 二、 為什麼需要「打洞」？

- **NAT 的阻礙**：正常情況下，外部封包主動敲門（連入）會被路由器攔截丟棄。
- **P2P 的需求**：線上遊戲（如 Switch、PS5）、遠端桌面（AnyDesk）、即時通訊軟體（VoIP），為了降低延遲和節省伺服器成本，必須讓兩台電腦直接溝通。

### 三、 打洞的黃金拍檔：STUN 伺服器

- **STUN (Session Traversal Utilities for NAT)**：這是一個位於公網的第三方伺服器，扮演「媒人」角色。
- **它的作用**：
    1. 告訴 Client A：你對外的公網 IP 與 Port 是多少。
    2. 告訴 Client B：你對外的公網 IP 與 Port 是多少。
    3. 互相交換資訊：讓 A 拿到 B 的位址，B 拿到 A 的位址。

### 四、 UDP 打洞五步驟（動作拆解）

假設 A、B 都要連線，且已經透過 STUN 伺服器拿到了對方的資料：
1. **同步發起**：STUN 伺服器通知 A 與 B 同時啟動。
2. **A 先發制人**：A 對 B 的公網位址發送封包。
    - _結果_：這個包會被 B 的路由器攔下，但 **A 的路由器紀錄了：`A 剛才發信給 B，我在等 B 回信`**。
3. **B 同步出擊**：B 對 A 的公網位址發送封包。
    - _結果_：這個包會抵達 A 的路由器。
4. **保全受騙（關鍵點）**：A 的路由器看到 B 的封包，檢查紀錄發現「A 剛才確實有寄信給 B」，於是認為這是「合法回信」，直接放行！
5. **隧道建立**：一旦有一邊放行，通道（Hole）就打通了，雙方可以開始 P2P 通訊。
    
### 五、 失敗的致命傷：對稱型 NAT (Symmetric NAT)

- **失敗原因**：對稱型 NAT 在連向不同對象（STUN 伺服器 vs 另一台 Client）時，會**隨機更換對外 Port**。
- **現象**：A 告訴伺服器的 Port 是 `10001`，但實際敲 B 門時變成了 `10005`。B 往 `10001` 回信，A 的路由器會覺得「這不是我剛才寄出的那封信的回信」，因此拒收。

---
## 中繼伺服器 (Relay / TURN) >對外下下策

### 一、 基本概念

- **定義**：中繼是一種「客戶端-伺服器-客戶端」的通訊模式。當兩台裝置無法直接建立連線時，透過一台位於公網的第三方伺服器作為**中轉站**，負責接收 A 的數據並轉發給 B，反之亦然。
- **核心協議**：**TURN (Traversal Using Relays around NAT)**。
- **本質**：它是一種「代通訊」服務，伺服器必須同時維持與通訊雙方的連線。
- 典型範例:Radmin VPN

### 二、 運作原理：收發室模式

想像兩家公司的員工因為安全門禁無法直接見面，他們透過一個公用的「郵局」來溝通：
1. **建立連線**：設備 A 與設備 B 分別主動連向 **中繼伺服器**。
2. **身分綁定**：伺服器為這對通訊分配一個唯一的「會話 ID (Session ID)」。
3. **上傳數據**：A 把要給 B 的資料寄到伺服器。
4. **轉發數據**：伺服器收到後，根據 ID 找到 B 的連線路徑，將資料推播給 B。

### 三、 為什麼需要中繼？（使用場景）

儘管現代網路有許多穿透技術，但中繼在以下情況是「唯一」解方：
1. **極端防火牆限制**：企業或政府防火牆只允許對特定公網伺服器進行通訊，禁止任何形式的端對端連線。
2. **高度對稱型網路**：網路環境變動劇烈，導致無法預測埠號，只能透過固定點中轉。
3. **封包檢測 (DPI)**：某些 ISP 會攔截並丟棄非標準的 P2P 封包，此時偽裝成一般伺服器通訊的中繼最為穩定。

### 四、 中繼技術的特徵

#### 1. 100% 的連通率

只要雙方都能連上網際網路，中繼幾乎保證能建立通訊。它不依賴 NAT 的類型，也不管路由器是否支援特殊功能。
#### 2. 高昂的頻寬成本

這是中繼與其他技術最大的不同：
- **流量負擔**：每一位元的數據都必須消耗伺服器的上傳與下載頻寬。
- **商業模式**：這也是為什麼大多數遠端軟體（TeamViewer, AnyDesk）對「高流量中繼」會採取限速或收費策略。

#### 3. 延遲 (Latency) 增加

由於數據必須「多跑一趟」到伺服器再回來，通訊延遲至少會增加：
$$\text{Total Latency} = (\text{A to Server}) + (\text{Server to B})$$
如果伺服器地理位置較遠（例如你在台灣連台灣，但中繼伺服器在日本），延遲感會非常明顯。

### 五、 中繼伺服器的安全性

- **端到端加密 (E2EE)**：雖然數據經過伺服器，但現代成熟的軟體（如 WhatsApp 或 Signal 的通話）會在 A 處加密，B 處解密。
- **伺服器的角色**：在這種情況下，中繼伺服器雖然轉發了封包，但它就像快遞員一樣，**「看得到包裹，但拆不開內容」**。

---
## DMZ (非軍事區)
### 一、 基本概念

- **定義**：在路由器上設定一台「特權主機」，讓它接收**所有**未被其他規則（如端口轉發）指定的外部流量。
- **本質**：它是 NAT 的「全開模式」。相對於一個一個開洞（端口轉發），DMZ 是直接把整面牆推倒。
- **口訣**：**「找不到人的包裹，通通丟給它！」**
- 基本用來做測試 非必要不會開啟

### 二、 運作原理

1. **外部連線**：有人嘗試連入你的公網 IP，但沒有指定特定端口，或指定的端口你沒設定規則。
2. **路由器判斷**：
    - 有設定「端口轉發」嗎？ $\rightarrow$ 有，傳給指定設備。
    - 有設定「DMZ」嗎？ $\rightarrow$ 有，傳給 DMZ 主機。
    - 端口轉發權重>DMZ權重
3. **最終去向**：如果上述都沒有，封包直接被丟棄 (Drop)。

# P.S. 端口=通訊埠=Port 意旨你的電腦網路使用哪個開口